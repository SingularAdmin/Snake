<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Snake Game</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
    <style>
        .main {
            display: flex;
            text-align: center;
            border: 2px solid rgb(22, 9, 34);
        }

        .canvas {
            border: 3px ridge rgb(54, 27, 82);
            border-radius: 9px;
        }

        .scoreBord {
            display: flex;
            flex-direction: column;
            background-color: rgb(231, 243, 191);
            font-size: 128%;
            font-style: italic;
            font-weight: bold;
            flex-grow: 1;
            border: 2px solid rgb(54, 27, 82);
            color: rgb(85, 19, 54);
        }

        hr {
            display: block;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            margin-left: auto;
            margin-right: auto;
            border-style: 2px solid rgb(54, 27, 82);
            border-width: 2px;
            width: 75%;
        }

        .stats {
            float: right;
        }

        .skins {
            height: 50%;
            border-style: 2 solid rgb(54, 27, 82);
        }
    </style>
</head>

<body>
    <div class="main">
        <canvas class="canvas" id="Canvas"></canvas>

        <div class="scoreBord">
            <div>
                <p class="stats" id="stats"></p>
                <p id="score">Score: 0</p>
            </div>
            <hr />
            <div class="log" id="log">

            </div>
            <div class="skins">
                <select name="skins" id="skins">
                    <option value="skin1.jpg">Skin 1</option>
                    <option value="skin2.jpg">skin 2</option>
                    <option value="skin3.jpg">skin 3</option>
                </select>
                <select name="food" id="food">
                    <option value="apple.jpg">apple</option>
                    <option value="rat.jpg">rat</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        //Init canvas and context
        const canvas = document.getElementById("Canvas")
        let Width = 1200
        let Height = 800
        let Scale = 20
        canvas.width = Width
        canvas.height = Height

        const ctx = canvas.getContext("2d")
        ctx.moveTo(0, 0)
        ctx.scale(Scale, Scale)

        const skinImg = new Image();
        skinImg.src = "./skin1.jpg"

        const appleImg = new Image();
        appleImg.src = "./apple.jpg"

        const headImg = new Image();
        headImg.src = "./head2.jpg"

        let message = (x) => alert(x)
        let score = 1

        let stats = document.getElementById("stats")

        let stop = false;
        let frameCount = 0;
        let results = document.getElementById("results");
        let fps, fpsInterval, startTime, now, then, elapsed;
        //Init game data snake
        let snake = []

        const resetSnake = () => {
            snake = [
                [0, 3],
                [0, 2],
                [0, 1],
                [0, 0]
            ]
        }
        //Setting Listeners 
        let skins = document.getElementById("skins");
        skins.addEventListener('change', (event) => {
            console.log(event.target.value)
            skinImg.src = "./" + event.target.value
        }, false)

        let food = document.getElementById("food");
        food.addEventListener('change', (event) => {
            console.log(event.target.value)
            appleImg.src = "./" + event.target.value
        }, false)

        const arrayEquals = (a, b) => {
            return Array.isArray(a) &&
                Array.isArray(b) &&
                a.length === b.length &&
                a.every((val, index) => val === b[index]);
        }

        const keyEvent = document.addEventListener('keydown', (event) => {
            let key = event.key;
            state.direction = [0, 0]
            switch (key) {
                case "ArrowUp": state.direction[1] = -1
                    break;
                case "ArrowDown": state.direction[1] = 1
                    break;
                case "ArrowLeft": state.direction[0] = -1
                    break;
                case "ArrowRight": state.direction[0] = 1
                    break;
            }
        }, false)

        const directionLogic = () => {

        }

        const addLog = (user, score) => {
            let log = document.getElementById("log")
            var br = document.createElement("br");
            const info = user + ", Score: " + score
            log.append(info)
            log.append(br)
        }

        const space = []
        const calculateFreeSpace = () => {
            for (let i = 0; i <= Width / Scale; i++) {
                for (let j = 0; j <= Height / Scale; j++) {
                    space.push([i, j])

                }
            }
            let randPos = space[Math.floor(Math.random() * space.length)]
            //testing
            ctx.fillRect(randPos[0], randPos[1], 1, 1)
        }

        const state = {
            walls: { left: 0, right: (Width / Scale), top: 0, bottom: (Height / Scale) },
            direction: [0, 1],
            food: {
                exists: false,
                type: "apple",
                position: [0, 0]
            }
        }

        const checkIfSnakeEats = () => {
            let head = snake[0]

            let foodPos = state.food.position
            if (head[0] === foodPos[0] && head[1] === foodPos[1]) {
                snake.push([foodPos[0], foodPos[1]])
                state.food.exists = false
                document.getElementById("score").innerText = "Score: " + score++
            }
        }

        const snakeEatsSelf = (head) => {
            if (snake.some(el => el[0] === head[0] && el[1] === head[1])) {
                return true
            } else {
                return false
            }
        }

        const Dialog = () => {
            let text;
            let person = prompt("Please enter your name:", "Name");
            if (person == null || person == "") {
                text = "User cancelled the prompt.";
            } else {
                addLog(person, score)
            }
        }

        const wallHitPos = (head) => {
            let newhead = head
            if (head[0] >= state.walls.right) {
                newhead = [state.walls.left, head[1]]
            }
            if (head[0] < state.walls.left) {
                newhead = [state.walls.right, head[1]]
            }
            if (head[1] >= state.walls.bottom) {
                newhead = [head[0], state.walls.top]
            }
            if (head[1] < state.walls.top) {
                newhead = [head[0], state.walls.bottom]
            }
            return newhead;
        }

        const gameLoop = () => {
            now = Date.now();
            elapsed = now - then;
            window.requestAnimationFrame(gameLoop);
            // if enough time has elapsed, draw the next frame
            if (elapsed > fpsInterval) {
                // Get ready for next frame by setting then=now, but also adjust for your
                // specified fpsInterval not being a multiple of RAF's interval (16.7ms)
                then = now - (elapsed % fpsInterval);
                // Game starts here
                frameCount = "fps:" + Math.floor(elapsed)
                stats.innerHTML = frameCount;

                if (stop) {
                    Dialog()
                    score = 0
                    resetSnake()
                    stop = false
                }

                let head = snake[0]
                let x, y
                [x, y] = head

                let newHead = wallHitPos([x + state.direction[0], y + state.direction[1]])
                if (!snakeEatsSelf(newHead)) {
                    snake.unshift(newHead)
                    snake.pop()
                } else {
                    stop = true
                }

                if (state.food.exists) {
                    checkIfSnakeEats()
                } else {
                    state.food.position = [Math.floor(Math.random() * state.walls.right), Math.floor(Math.random() * state.walls.bottom)];
                    state.food.exists = true
                }

                draw()
            }
        }
        //Graphics
        const draw = () => {
            ctx.clearRect(0, 0, Width, Height)

            ctx.drawImage(appleImg, state.food.position[0], state.food.position[1], 1, 1)

            //create current snake
            snake.forEach(([x, y]) => ctx.drawImage(skinImg, x, y, 1, 1));
            //set head Image
            ctx.drawImage(headImg, snake[0][0], snake[0][1], 1, 1)
        }

        const startAnimating = (fps) => {
            fpsInterval = 1000 / fps;
            then = Date.now();
            startTime = then;
            resetSnake()
            gameLoop()
        }
        // initialize the timer variables and start the animation
        startAnimating(20)


    </script>
</body>

</html>